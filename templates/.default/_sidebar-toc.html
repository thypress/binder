<!-- SPDX-License-Identifier: MPL-2.0

This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at https://mozilla.org/MPL/2.0/.
-->

{{#if showToc}}
<aside class="sidebar-toc">
  <h2>On This Page</h2>
  <nav class="toc">
    {{> _toc-tree items=toc}}
  </nav>
</aside>

<script>
// Scroll spy for TOC active highlighting
(function() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const id = entry.target.getAttribute('id');
      const tocLink = document.querySelector(`.toc a[href="#${id}"]`);

      if (tocLink) {
        if (entry.isIntersecting) {
          // Remove active from all links
          document.querySelectorAll('.toc a').forEach(link => {
            link.classList.remove('active');
          });
          // Add active to current link
          tocLink.classList.add('active');
        }
      }
    });
  }, {
    rootMargin: '-20% 0px -35% 0px'
  });

  // Observe all headings that have IDs
  document.querySelectorAll('article h2[id], article h3[id], article h4[id]').forEach((heading) => {
    observer.observe(heading);
  });

  // Smooth scroll for TOC links
  document.querySelectorAll('.toc a').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const id = link.getAttribute('href').substring(1);
      const target = document.getElementById(id);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Update URL without triggering page jump
        history.pushState(null, null, `#${id}`);
      }
    });
  });
})();
</script>
{{/if}}
